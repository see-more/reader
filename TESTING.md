# Reader 项目测试文档

## 测试概览

本项目使用 Jest 测试框架，对三个核心模块进行了全面的单元测试和集成测试。

### 测试覆盖结果

```
File                 | % Stmts | % Branch | % Funcs | % Lines | Uncovered Line #s
---------------------|---------|----------|---------|---------|-------------------
All files            |   81.28 |    87.93 |   63.82 |   83.55 |
models              |   77.41 |       90 |      60 |   77.58 |
  Book.ts            |   97.05 |    85.71 |     100 |     100 | 32-35
  BookChapter.ts     |     100 |      100 |     100 |     100 |
stores              |   47.36 |      100 |   47.05 |      50 |
  BookStore.ts       |     100 |      100 |     100 |     100 |
utils               |   91.11 |    86.84 |     100 |   91.66 | 41-43,123-126
  calculateBook.ts   |   91.11 |    86.84 |     100 |   91.66 |
```

## 模块详情

### 1. Book 模型 (models/Book.ts & models/BookChapter.ts)

**覆盖率:**
- Book.ts: 97.05% 语句覆盖率，100% 函数覆盖率
- BookChapter.ts: 100% 覆盖率

**测试场景:**
- 构造函数行为（有无章节标记的各种情况）
- 章节内容的加载和缓存
- 预加载章节
- 缓存清理
- 边缘情况（空文本、纯空格、特殊字符、连续章节标记等）
- 不同章节标记格式（中文数字、阿拉伯数字、带/不带分隔符）

**测试数量:** 58 个测试用例

### 2. calculateBook 工具函数 (utils/calculateBook.ts)

**覆盖率:** 91.11% 语句覆盖率，100% 函数覆盖率

**测试场景:**
- 章节分页计算 (calculateChapter)
- 書籍分页计算 (calculateBook)
- 缓存操作（添加、获取、清理）
- 缓存统计
- 预加载章节
- 字形结构验证
- 边缘情况（空内容、超长行、纯空白内容、无效参数）
- 缓存键生成和参数变化

**测试数量:** 46 个测试用例

### 3. BookStore 状态管理 (stores/BookStore.ts)

**覆盖率:** 100% 所有覆盖率指标

**测试场景:**
- 初始状态
- 添加单个书籍
- 添加多个书籍
- 批量添加书籍 (addAllBooks)
- 删除书籍（单个、中间、开头、结尾）
- 特殊属性书籍（零大小、超大文件、不同 MIME 类型）
- 边缘情况（相同 URI 的书籍、特殊字符书名、空数组）
- 集成测试（连续操作、状态完整性）

**测试数量:** 48 个测试用例

## 运行测试

```bash
# 运行所有测试
npm test

# 运行测试并查看覆盖率
npm run test:coverage

# 以监视模式运行测试
npm run test:watch
```

## 测试配置

- **测试框架:** Jest
- **preset:** babel-preset-expo
- **Mock 配置:** jest.setup.js
- **覆盖率收集范围:** models, utils, stores

## 章节标记格式

Book 模型使用正则表达式识别章节标记：

```
/[第章回部节集卷] *[\d一二三四五六七八九十零〇百千两]+ *[第章回部节集卷]( |、)/g
```

这意味着章节标记必须符合以下格式：
- 以"第"、"章"等开头
- 中间有数字（阿拉伯或中文）
- 以"章"、"回"等结尾
- 标记后必须有空格或顿号

有效示例:
- "第一章 "
- "第2章 "
- "第一回、"

无效示例:
- "第一章"
- "第一章测试"
- "第一章\n"

## 未覆盖代码说明

### Book.ts (行 32-35)
此分支为防御性代码，当匹配结果为空时跳过，在正常情况下很难触发。

### calculateBook.ts (行 41-43, 123-126)
- 行 41-43: LRU 缓存淘汰逻辑（仅当缓存达到最大值 50 时触发）
- 行 123-126: 边缘情况下的重置逻辑（需要特定条件）

这些未覆盖区域主要为性能优化和极端情况的处理，不影响核心功能。

## 测试最佳实践

1. **隔离性**: 每个测试独立运行，使用 `beforeEach` 清理状态
2. **Mock**: 使用 jest.setup.js 统一 mock 外部依赖
3. **边缘情况**: 考虑空值、边界值、特殊字符等情况
4. **集成测试**: 验证模块之间的交互
5. **类型安全**: 包含类型验证测试确保接口正确

## 持续改进

未来可以改进的方向：
1. 增加缓存溢出场景的测试（大量章节）
2. 添加性能基准测试
3. 增加更多错误情况的测试
4. 添加端到端测试

---

最后更新: 2026-02-16
