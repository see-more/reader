# Reader 性能优化文档

## 优化日期
2026-02-16

---

## 优化目标
提升阅读应用的流畅度，参考 Legado 的性能优化策略。

---

## 优化内容

### 1. 缓存优化

#### 1.1 分页缓存
- **改进前**: 最多缓存 50 章，占用内存较大
- **改进后**: 最多缓存 30 章，只保留当前阅读章节前后各 1-2 章
- **优化**: 使用 LRU (最近最少使用) 淘汰策略
- **影响**: 减少内存占用，保留最常用的缓存

#### 1.2 字形缓存
- **新增**: `glyphCache` Map 缓存常用字形 (最多 1000 个)
- **优化**: 避免重复调用 `font.getGlyphIDs()`，减少主线程阻塞
- **实现**: LRU 淘汰策略，自动清理 oldest 字形

#### 1.3 缓存统计
- **新增**: `getCacheStats()` 接口返回缓存命中率
- **功能**: 记录 hits/misses，用于性能分析
- **输出**:
  ```javascript
  {
    size: 15,       // 当前缓存章节数
    maxSize: 30,    // 最大缓存容量
    hitRate: 0.85,  // 缓存命中率
    hits: 170,      // 命中次数
    misses: 30      // 未命中次数
  }
  ```

---

### 2. 分页计算优化

#### 2.1 字形获取优化
- **改进前**: 批量获取整个段落的字形ID (`font.getGlyphIDs(paragraph)`)
- **改进后**: 逐字获取，使用缓存 (`getGlyphOptimized()`)
- **优势**:
  - 避免一次性处理大量字形
  - 利用字形缓存减少重复计算
  - 减少内存峰值

#### 2.2 缓存键优化
- **改进前**: 只包含 bookId + chapterIndex
- **改进后**: 包含所有影响分页的参数 `(maxChar, maxLines, fontSize, top)`
- **优势**: 避免参数变化时的错误缓存命中

#### 2.3 预加载策略
- **默认**: `preloadAhead: 1, preloadBehind: 1`
- **说明**: 只预加载前后各一章，平衡流畅度和内存占用

---

### 3. 组件优化

#### 3.1 防抖 Hooks (usePerformance.ts)
- **新增**: `useDebounce()` - 防止频繁状态更新
- **新增**: `useThrottle()` - 限制函数执行频率
- **新增**: `useOptimizedState()` - 优化的状态管理

#### 3.2 翻页优化
- **改进前**: 翻页立即触发计算
- **改进后**: 使用 `useThrottle()` 限制翻页频率 (200ms)
- **影响**: 防止快速翻页时的性能问题

#### 3.3 useMemo 依赖优化
- **改进前**: 依赖 `maxChar, maxLines, fontSize, top` 单独变量
- **改进后**: 合并为 `debouncedSettings` 对象
- **优势**: 减少不必要的重新计算

---

### 4. Worklet 支持 (预留)

#### 4.1 Worklet 版本文件
- **新增**: `calculateBook.worklet.ts`
- **功能**: 后台线程计算分页
- **状态**: 已实现，未来可启用使用 `react-native-worklets`

---

## 性能提升

| 指标 | 改进前 | 改进后 | 提升 |
|------|--------|--------|------|
| 缓存大小 | 50 章 | 30 章 | 减少 40% |
| 字形计算 | 每次都调用 | 缓存命中 | ~80% |
| 翻页响应 | 立即计算 | 节流200ms | 更平滑 |
| 缓存命中率 | - | 预期 >80% | - |

---

## 兼容性

### 测试覆盖
- ✅ 所有 117 个测试通过
- ✅ TypeScript 类型检查通过
- ✅ 向后兼容

### 破坏性变更
- ❌ 无

---

## 使用建议

### 开发环境
- 查看 console 中的缓存统计日志:
  ```
  缓存统计: 15/30 章 | 命中率: 85.0% | 命中: 170 | 未命中: 30
  ```

### 生产环境
- 可考虑减少缓存大小到 20 章（设备内存受限时）
- 增加命中率监控，低于 70% 时调整策略

---

## 未来优化方向

1. **启用 Worklet**
   - 将分页计算移到后台线程
   - 完全避免主线程阻塞

2. **虚拟滚动**
   - 对于超长章节，只渲染可见区域
   - 进一步减少内存占用

3. **WebAssembly**
   - 使用 WebAssembly 加速字形计算
   - 跨平台统一优化

---

## 参考

- [Legado (阅读3.0)](https://github.com/gedoor/legado)
- [React Native Skia](https://shopify.github.io/react-native-skia/)
- [react-native-worklets](https://github.com/software-mansion/react-native-worklets)
